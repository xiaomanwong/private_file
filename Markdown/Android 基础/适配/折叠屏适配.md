# 折叠屏适配

> 研发
> 设计
> 测试

[折叠屏适配](https://blog.csdn.net/h4x0r_007/article/details/122325680)

[华为折叠屏适配方案](https://developer.huawei.com/consumer/cn/doc/development/other/responsive_layout-0000001249470186)


[掘金折叠屏适配](https://juejin.cn/post/7049705037525680164)
[Demo](https://github.com/android/user-interface-samples/blob/master/WindowManager/app/src/main/res/layout/activity_display_features.xml#L57)

**折叠形态**
* 展开态：完全展开后的形态；尺寸更大，可充分显示应用内容
* 折叠态：折叠后形态；屏幕尺寸变小
* 支架态：完全展开与折叠的中间态，可平稳放置
![Img](https://developer.android.com/static/images/guide/topics/large-screens/foldables/foldable_multiple_postures.png?hl=zh-cn)



**体验设计点**
特点：可随时折叠展开、展开后屏幕变大

**UX 设计体验诉求**
1. 体验连续
可随时折叠展开，在体验上要保证用户体验的连续性，需要遵从屏幕显示的兼容和应用状态的连续
屏幕兼容：由于尺寸发生变化，应用应采用适当的手段对屏幕上的内容布局进
行调整
应用连续：在折叠与展开状态切换的过程中保持正常运行
2. 体验增值
    屏幕变大后，用户体验在某些方面有增值
    * 更多内容：大尺寸屏幕可显示更多内容，**提高显示和操作效率**
    * 更加沉浸：大尺寸屏幕可显示更清晰的细节，适合图片浏览、视频欣赏、游戏等应用场景。
    * 多任务并行：多窗口可同时在大尺寸屏幕内显示，为用户多任务并行提供了直观高效的方式。

---         

1. 信息展示完整：
展开态内容元素不少于折叠态信息量的 3/4
1. 交互不中断
    1. 展开不出现操作步骤增加，操作复杂等体验下降的情况
    1. 不破坏应用内原有的沉浸式体验，避免仅仅为了快充内容或强制应用分屏而过度改变用户体验和用户习惯
    1. 折叠态和展开态切换时，需要保证当前任务连续。切换之前的任务和相关状态保存、延续，或能够快速恢复，给用户提供连续的体验。不发生闪退、重启等异常。

折叠展开动作，会触发对 `smallestscreensize, screensize 和 screenlayout` 的配置更改。默认情况下会销毁并重新创建整个 `Activity` 

```xml
    <Activity android:name=".MyActivity"
        android:configChanges="screenlayout|screensize|smallestscreensize"
    />
```

重写 `onConfigurationChanged(config: Configuration)` ,根据参数获得屏幕的分辨率等信息，针对不同比例屏幕下的应用布局做相应调整，如切换、调整空间位置和间距等。
```java
public void onConfigurationChanged(Configuration newConfig){
    super.onConfigurationChanged(newConfig);
    Log.i("test", "newConfig.screenHeightDp:" + newConfig.screenHeightDp + ", newConfig.screenWidthDp"+newConfig.screenWidthDp);

    // 根据分辨率调整布局
}

```

如需要必须通过重新走生命周期来相应屏幕切换，需要进行状态的保存和恢复
通过 `OnSaveInstanceState()` 和 `ViewModel` 对象进行状态保存和后续的恢复。销毁之前，通过 `onSaveInstancesState()` 存储状态， 在 `onCreate()`  和 `onRestoreInstanceState()` 进行恢复。


## 横竖屏旋转适配
折叠屏在展开状态下的屏幕显示比例接近正方形，应用设计和开发时需要考虑如下：
1. 支持展开态横屏显示。
1. 展开态横竖屏布局一致。除部分特殊界面外，建议应用在横屏和竖屏下保持一样的布局。    
![Img](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20220629161827.66148998603796895408022476417337:50530628094615:2800:F0412A848531C06D41A5D78691B879A1346BA292FBA802B6C58E0161720F2E36.jpg?needInitFileName=true?needInitFileName=true)

### 关键元素适配
图标和字体大小不应发生改变，最大不超过 1.2 倍。

### 图片/视频适配
展开态的图片/视频应适应页面的宽度、间距、列数等因素进行适配显示，不能造成信息量的明显减少。

第一种：运营类图片、视频，通常是 Banner 的运营广告类或分类入口
（1）展开态下，增加运营类内容的显示列数
（2）展开态方法显示图片/视频，确保该图片/视频不超过屏幕的 1/2高度
第二种：首页内容缩略图/视频/卡片。
（1）九宫格布或瀑布流布局的图片/视频/卡片：建议在展开态增加显示列数为原来的二倍。特殊情况如展开态显示三列，则单个图片/视频/卡片高度不超过屏幕 1/2高度
（2）上下图文布局：建议在展开态平铺显示更多图/视频/卡片居右对齐/居中对齐。单张图片/视频最高不超过 1/3高度。
第三种：详情页具体内容图片/视频，是内容消费的主题，一般是各类内容的子页面，英语展示更多详细信息。
（1）详情页展开态的内容图片/视频可适当等比放大且居中/居左/居右对齐。
（2）详情内容带文字是，图片/视频高度建议不超过屏幕的 80%；详情内容仅图片/视频时，图片/视频高度不超过 1 屏幕。超长图情况特殊除外。
（3）有多个图片/视频时，详情页展开态的内容图片/视频横向排列。

### 弹框适配
弹框建议展开态和折叠台保持相同大小，或最大不超过 1.2 倍

![Img](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20220629161836.44008660657243648984191118625374:50530628094615:2800:FFD73E518B25D03DF6B81C4ACF3EC0AE36654583DB4462D35046B491CD2230BF.jpg?needInitFileName=true?needInitFileName=true)

### 其他控件适配
页面中的其他界面元素，如按钮、输入框，建议展开折叠时高度按照字体大小的缩放比例进行缩放，或大小变化不超过 1.2 倍，宽度根据元素本身的响应式规则进行设计，部分元素（按钮）保持等比缩放，部分元素（列表、输入框）对宽度进行适当延伸，最宽不超过整个窗口。


















## 适配内容

### 悬浮窗

推荐禁用

```xml
<application
     android:name=".MyActivity"
     android:resizeableActivity=["true" | "false"] />
````

targetSdk 大于等于 N(24)， 默认为 true，支持多窗口。

`activity.getResource().getConfiguration().windowConfiguration.getBounds()`

从 Activity 的上下文从资源中获取窗口大小（dp)
```


`activity.getResource().getDisplayMetrics().widthScreenHeightDp`
`activity.getResource().getDisplayMetrics().widthScreenWidthDp`

activity.getResources().getDisplayMetrics().widthPixels
activity.getResources().getDisplayMetrics().heightPixels
```

多窗口DecorCaptionView层级设计

悬浮窗场景下，窗口中会被系统插入一个DecorCaptionView标题栏，该标题栏是DecorView的子节点，是ContentView的父节点，应用实现不要在ContentView父节点上插入布局，以免与DecorCaptionView冲突。

![Img](https://developer.android.com/static/images/guide/topics/large-screens/foldables/fold-unfold.gif?hl=zh-cn)

### 响应式布局
避免使用物理硬件值来确定布局。（平板电脑？特定宽高比？）



















## 实施方案
### 禁止悬浮窗
    
```xml
<application
     android:name=".MyActivity"
     android:resizeableActivity=["true" | "false"] />
```



### 引入依赖
```grovvy
    implementation andridx.window:window:1.0.0
```


```kotlin

class FoldingFeature {
    class State {
        companion object {
            // 展平态
            const val FLAT: FoldingFeature.State
            // 半展态
            const val HALF_OPENED :FoldingFeature.State
        }
    }

    class Orientation{
        companion object {
            const val HORIZONTAL: FoldingFeature.Orientation
            const val VERTICAL :FoldingFeature.Orientation
        }
    }

    class OcclusionType {
        companion object {
            const val FULL: FoldingFeature.OcclusionType
            const val NONE :FoldingFeature.OcclusionType
        }
    }
}
```

```kotlin

class DisplayFeaturesActivity : AppCompatActivity() {

    private lateinit var binding: ActivityDisplayFeaturesBinding

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        binding = ActivityDisplayFeaturesBinding.inflate(layoutInflater)
        setContentView(binding.root)

        lifecycleScope.launch(Dispatchers.Main) {
            lifecycle.repeatOnLifecycle(Lifecycle.State.STARTED) {
                WindowInfoTracker.getOrCreate(this@DisplayFeaturesActivity)
                    .windowLayoutInfo(this@DisplayFeaturesActivity)
                    .collect { newLayoutInfo ->
                        // Use newLayoutInfo to update the layout.
                    }
            }
        }
    }
}

```

### 可折叠设备显示屏的功能
Jetpack WindowManager 的 WindowLayoutInfo 类可将显示窗口的功能作为 DisplayFeature 元素列表提供。

FoldingFeature 是一种类型的 DisplayFeature，它提供了有关可折叠设备显示屏的信息，其中包括：

* state：设备的折叠状态，即 FLAT 或 HALF_OPENED
* orientation：折叠边或合页的方向，即 HORIZONTAL 或 VERTICAL
* occlusionType：折叠边或合页是否遮住了显示屏的一部分，即 NONE 或 FULL
* isSeparating：折叠边或合页是否创建了两个逻辑显示区域，即 true 或 false

