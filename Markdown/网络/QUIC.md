# QUIC

[QUIC 介绍](http://www.52im.net/thread-1309-1-1.html)

**TCP**

* 数据传输协议，创建时需要进行三次握手，如果需要提高数据交互安全性，需要增加 TLS （传输层安全协议），并增加一次握手次数。
* TCP 传输稳定，但在网络基建本身已经越来越完善的情况下，TCP 的设计本身问题暴露处理，在弱网环境下，性能堪忧。

**UDP**

* UDP 是无连接协议，不需要三次握手，客户端发出 UDP 数据包后，只能“假设”数据包已经被服务器接收。
* 在网络传输层无需对数据包进行确认，提高速率
* 无法保证数据传输可靠性，应用层协议需要自己完成包传输情况的确认

## QUIC

QUIC 是 Quick UDP Internet Connections 的缩写，由 Google 提出的新传输协议。

QUIC 可以在 1 到 2 个数据包（取决于链接的服务器是新的还是已知的）内，完成链接的创建（包括 TLS）

## QUIC 协议的目标

QUIC 的主要目的是为了整合 TCP 协议的可靠性和 UDP 协议的速度和效率

![](https://s2.loli.net/2022/01/14/fi1ElF6sNwU9oBh.png)

通信延迟对比：

![](https://s2.loli.net/2022/01/14/4lSBXHxwjupJ1N9.png)

## 为什么需要 QUIC 

从上世纪 90 年代互联网开始兴起到现在，大部分的互联网流量传输只是用了几个网络协议。是用 IPV4 进行路由，使用 TCP 进行连接层面的流量控制，使用 SSL/TLS 协议实现传输安全，使用 DNS 进行域名机械，使用 HTTP 进行应用数据的传输。

近 30 年来，这几个协议的发展非常缓慢。TCP 主要是拥塞控制算法的改进，SSL/TLS 基本上停留在原地，几个小版本的改动主要是密码套件升级， TLS1.3 是一个飞跃变化，但截止目前还没有发布。IPv4 虽然有一个大的进步，实现了 IPv6，DNS 也增加了一个安全的 DNSSEC，但和 IPv6 一样，部署进度较慢。

**几个由来已久的问题和矛盾**

* 协议历史悠久导致中间设备僵化
* 依赖于操作系统的实现导致协议本身僵化
* 建立队列的握手延时大
* 队头阻塞

### 中间设备僵化

TCP 协议使用的太久，也非常可靠。所以中间设备，包括防火前、NAT 网关、整流器等出现了一些约定成俗的动作。

防火墙只允许通过 80 和 443 端口，不放过其他端口。NAT 网关在转换网络地址时重写传输层的头部，可能导致双方无法使用新的传输格式。整流器和中间代理有时候处于安全的需要，会删除一些他们不认识的选项字段。

### 依赖于操作系统的实现导致协议僵化

TCP 是操作系统在内核层面实现的，应用程序是能使用，不能直接修改。虽然应用程序的更新迭代速度非常快速和简单。但是 TCP 的迭代却非常缓慢，原因就是操作系统升级很麻烦。目前还存在大量用户使用，尽管已经存在了快 20 年。TCP 的特性更新，也很难快速推广。

### 建立连接的握手延迟大

不管是 HTTP1.0/1.1 还是 HTTPS， HTTP2，都使用了 TCP 进行传输。HTTPS 和 HTTP2 还需要使用 TLS 协议来进行安全传输。

**这就出现了两个握手延迟：**

* TCP 三次握手导致的 TCP 连接建立的延迟
* TLS 完全握手需要至少 2 个 RTT 才能建立，简化握手需要 1 个 RTT 的握手延迟。

对于短连接场景，这样的握手延迟影响很大，且无法消除。

### 队头阻塞

队头阻塞主要是 TCP 协议的可靠性机制引入的，TCP 使用序列号来标识数据的顺序，数据必须按照顺序处理，如果前面的数据丢失，后面的数据就算到达了也不会通知应用层来处理。

另外 TLS 协议层面也有一个队头阻塞，因为 TLS 协议都是按照 record 来处理数据的，如果一个 record 中丢失了数据，也会导致整个 record 无法正确处理

TCP 和 TLS1.2 的协议存在结构性的问题，如果过继续在现有的 TCP、TLS 协议上实现一个全新的应用层协议，依赖于操作系统、中间设备还有用户的支持。部署成本非常高，阻塞非常大。

## QUIC 核心特性

### 链接建立延时低

0RTT 建立连接可以时候 QUIC 比 HTTP2 最大的性能优势，什么是 0RTT 呢？

**有两个含义**

* 传输层 0RTT 就能建立连接
* 加密从 0RTT 就能建立加密连接

![HTTPS 及 QUIC 建连过程](https://s2.loli.net/2022/01/14/PTrFY97NcWImHOL.png)

左边 HTTPS 的一次完全握手的连接过程需要 3 个 RTT，而 QUIC，由于建立在 UDP 的基础上，同时又实现了 0RTT 的安全握手，所以在大部分情况下，只需要 0RTT 就能实现数据发送。

### 改进的拥塞控制

TCP 的拥塞控制实际上包含了四个算法：慢启动，拥塞避免，快速重传，快速恢复

QUIC 协议当前默认使用了 TCP 协议的 Cubic 拥塞控制算法，同事也支持 CubicBytes，Reno，RenoBytes,BBR,PCC 等拥塞控制算法。

从算法本身看，QUIC 只是重写了一次 TCP 协议。

**可插拔**

> 可插拔，就是能够非常灵活的生效，变更和停止。

1. 应用程序层面就能实现不同的控制算法，不需要操作系统，不需要内核支持。传统的 TCP 拥塞控制，必须要端到端的网络协议支持，才能实现控制效果。而内核和操作系统的部署成本非常高，升级周期长，在产品快速迭代，网络爆炸式增长的今天，有点满足不了需求。
2. 即使是单个应用程序的不同链接也能支持配置不同的拥塞控制。一台服务器，接入的用户网络环境也千差万别，结合大数据及人工智能处理，我们能 Wie 各个用户提供不同的但又更精准有效的拥塞算法，
3. 应用程序不需要停机和升级就能实现拥塞控制的变更，我们在服务端只需要修改一下配置，reload 一下，完全不需要停止服务器就能实现拥塞控制的切换。

**单调递增的 Packet Number**

### 基于 stream 和 connecton 级别的流量控制

### 没有队头阻塞的多路复用

### 加密认证的报文

TCP 协议头部没有经过任何加密和认证，所以在传输过程中很容易被设备篡改，注入和窃听。比如修改序列号、滑动窗口。这些行为可能出于性能优化，也有可能是主动攻击。

QUIC 的 packket 除个别报文比如 PUBLIC_RESET 和 CHLO，所有报文头部都是经过认证的，报文的 body 都是经过加密的。只要对 QUIC 报文任何修改，接收端都能够及时发现，有效降低安全风险。

红色部分为 Stream frame 的报文头部，有认证。绿色部分是报文内容，全部加密

![](https://s2.loli.net/2022/01/17/oqPDZ4xmC6de3Rl.png)

### 连接迁移

一条 TCP 连接是由四元组标识的（源 IP，源端口，目的 IP，目的端口）。什么叫连接迁移呢？就是当其中任何一个元素发生变化时，这条连接依然维持着，能够保持业务逻辑不中断。当然这里面主要关注的是客户端的变化，因为客户端不可控并且网络环境经常发生变化，而服务端的 IP 和端口一般都是固定的。

比如大家使用手机在 WIFI 和 4G 移动网络切换时，客户端的 IP 肯定会发生变化，需要重新建立和服务端的 TCP 连接。

又比如大家使用公共 NAT 出口时，有些连接竞争时需要重新绑定端口，导致客户端的端口发生变化，同样需要重新建立 TCP 连接。

### 其他亮点

此外，QUIC 还能实现前向冗余纠错，在重要的包比如握手消息发生丢失时，能够根据冗余信息还原出握手消息。

QUIC 还能实现证书压缩，减少证书传输量，针对包头进行验证等。

