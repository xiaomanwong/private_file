# 支付与钱包系统

## 钱包

钱包系统包括：

1. 上下游：上游包括交易系统、结算系统、CRM 等，下游包括资金系统、财务系统等。
2. 余额：可用余额=现金余额+赠送金+信用额度-未支付金额-冻结金额
3. 充值：包括用户线上充值、业务人员线下代充值、赠送金充值等
4. 支付、扣款：应收金额、实收金额、流水记录等
5. 退款：退款是支付的逆向流程（原路返回）
6. 体现：体现是充值的逆向流程（原路返回）



## 支付系统：

![](https://pic3.zhimg.com/v2-c8849c08dd7e25c9c1ad405fde02f26e_b.jpg)

在一个消费者付款流程中，支付系统需要完成以下任务：

1. 接收业务系统的业务订单
2. 根据业务订单类型及金额判断可支持的支付产品并返回给前端页面，让用户选择
3. 根据用户选择的支付产品，选出具体执行扣款的支付渠道
4. 根据选出的支付渠道要求组装质量，调用渠道执行扣款任务
5. 获取支付渠道通知的扣款结果或主动查询通道扣款结果
6. 通知业务系统支付结果

以上 6 个任务在具体执行中可以分化出以下几个单体

1. 支付应用

   平台每天有无数订单，支付系统需要将订单进行分类。不同类型的订单对支付渠道有着不同的需求，可以将订单类型对支付渠道的需求规则维护在**支付应用层**

   支付应用层供给上层业务统一模块化的调用方式，业务层不再关注支付的实现。一般来说，支付应用可分为即时消费（消费类订单），充值（钱包类业务），转账（钱包类业务），提现（钱包类业务），退款（异常情况处理）等。

   | 序号 | 支付应用 | 对支付渠道的要求        |
   | ---- | -------- | ----------------------- |
   |      | 消费     | 收款类支付产品          |
   |      | 转账     | 账户支付+账户入款       |
   |      | 提现     | 账户支付+付款类支付产品 |
   |      | 退款     | 付款类支付产品          |

2. 支付核心（支付产品）

   支付核心是将下游支付渠道自身带有的原子化功能（鉴权、签约、扣款等）封装后提供给上游统一调用。上游通道仅需要明确具体支付产品和金额后，由支付核心根据路由选出的渠道的接口要求组装指令，调用渠道支付接口。

   支付核心应封装渠道包括验证要素，支付额度，手续费，结算账户，查询方式等属性。也要能新渠道接入的可扩展性，屏蔽各渠道的差异，将渠道差异统一维护在单个系统中

3. 支付路由

   用户选择支付产品后，可以有多个支付渠道支持对应支付产品。系统需要根据特定逻辑选出具体的支付通道去执行扣款，而这个特定逻辑就是支付路由。

   这里至少要包括以下几个逻辑：

   1) 指定走某条通道、指定不走某条通道；

   2) 选出限额满足订单金额的支付通道；

   3) 选出手续费较低的通道；

   4) 现有的支付要素是否满足通道要求，是否仍需要用户参与。

   另外，支付应用中支持的具体支付产品，也可在路由中实现。
   
4. 渠道管理

   支付路由，和支付核心都需要根据通道特性进行判断，可以独立维护一个系统来记录通道的特性。当通道属性发生变化时，比如需要参数发生变化，费率发生变化等，通道维护时，可以在渠道管理系统中配置相关信息即可，而不需要重新发版。

   支付模型：

   ![](https://pic3.zhimg.com/v2-86251285c1d74e2caccd6399f48ebbce_b.jpg)

   支付系统：

   ![](https://pic4.zhimg.com/v2-89820d8dfe83852fe81ee230a6bb99c7_b.jpg)



C 端支付流程：

发起支付-> 选择渠道—> 创建订单->加签->发起支付-》支付结果-》结果回调