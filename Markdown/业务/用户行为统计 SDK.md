



## 结构

![统计SDK](https://raw.githubusercontent.com/xiaomanwong/static_file/master/images/%E7%BB%9F%E8%AE%A1SDK.jpg)

**API：**

* 初始化配置策略（上报策略，压缩方案）
* 对应不同业务，分类设计 api

**数据采集**

wwwwh 原则

who（谁），where（在哪），when（时间）， what（做了什么）， how（当时的环境）

WHO: 事件的归属人

WHERE:  在 app 中的具体位置

> BPFCU 模型
>
> B:business, 具体业务
>
> P:Page, 页面
>
> F:Feature,功能区
>
> C:Card， 卡片，展示业务数据的基本组合单元，跟控件区别在于，一个卡片通常是由若干页面，通过布局组合的方式，聚合成一个卡片。
>
> U: Unit， 单元，card 里最小粒度的组织单位，在技术上，可以是一个基本控件，也可以是一个复合控件。
>
> 

WHEN: 行为发生的时间以及正确上报的时间

WHAT: 事件的业务内容和类型，（点击，某某内容）

> 事件按归属，可以继续细分
>
> 1. 全局事件：与 app 的生命周期有关，如 app 启动、退出、进入后台、主要用于计算 app 存活时长
> 2. 页面事件：页面粒度事件，如，进入页面，离开页面，刷新页面，上拉页面等
> 3. 卡片事件：卡片力度的事件，如卡片曝光，卡片点击
> 4. 单元事件：单元粒度事件，如单元曝光， 单元点击

HOW: 上报的环境，如网络状态， wifi， 设备厂商等。

**数据加工：**

* 根据不同业务，给收集上来的数据绑定不同的业务数据，以及相同的设备等信息

拆解一条数据的组成

数据组埋点组成= action + context + entities

**用户行为（Action）：点击、订阅、分享、曝光**

**物理数据（context）：用户触发目标控件的屋里特性，如点击空间行为、位置、名称、视频播放时长等等（客户端产生）**

**逻辑数据（entities）：用户触发物理控件所绑定的业务数据，如文件标题， 简介、作者、内容**

**持久层：**

* 对加工后的数据进行存储，选用 Sqlite 数据库，原生好用，效率高，吞吐量大，比文件优秀。且是原生，不对 app 增加额外的包体积

**数据上报：**

* 采用单线程的方式，逐一从数据库中读取数据，并压缩处理，上传至服务器，成功后清除数据库中对应数据。上传失败，则取消上报保留数据。

| 触发条件                    | 条件值            | 说明                          |
| --------------------------- | ----------------- | ----------------------------- |
| flushInterval               | default 15s       | 触发上传的最大时间间隔        |
| flushBulkSize               | default 50 个事件 | 触发上传的最多缓存 Event 数量 |
| flutshBeforeEnterBackground | default true      | app 切后台时触发上传          |



**异常采集**

* 对于线上的异常问题，我们可以追踪采集数据的页面流转信息，以及报错信息，可以快速定位异常点、以及产生异常的流程
* 针对项目的主流程、核心路径监控，计算真实转化率。
* 被 catch 住的异常，虽然没有导致 app 崩溃，但程序的功能已经变的不可用，所以这些 catch 的异常也是需要上报的

